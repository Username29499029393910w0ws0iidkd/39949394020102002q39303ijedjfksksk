name: Android in Browser (Stable)

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
      - name: Install LocalTunnel & Docker
        run: |
          sudo apt update
          sudo apt install -y npm docker.io
          sudo systemctl start docker
          npm install -g localtunnel

      - name: Run Android Docker container
        run: |
          docker pull budtmo/docker-android-x86-8.1
          docker run -d --name android-box \
            -p 6080:6080 \
            -e DEVICE="pixel" \
            -e EMULATOR_ARGS="-no-window -noaudio -gpu swiftshader_indirect" \
            budtmo/docker-android-x86-8.1

      - name: Wait for Android to boot
        run: sleep 90

      - name: Start LocalTunnel
        id: tunnel
        run: |
          lt --port 6080 --subdomain android$(date +%s) > lt.log 2>&1 &
          sleep 8
          echo "LT_URL=$(grep -o 'https://[a-z0-9.-]*.loca.lt' lt.log | head -n1)" >> $GITHUB_ENV

      - name: Show access URL
        run: echo "ğŸŒ noVNC: $LT_URL/vnc.html"

      - name: Keep alive for 2 hours
        run: sleep 7200
