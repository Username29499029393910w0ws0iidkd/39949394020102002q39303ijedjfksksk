name: Android in Browser

on: [workflow_dispatch]

jobs:
  run-android:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y nodejs npm docker.io
          sudo systemctl start docker
          sudo usermod -aG docker $USER
          npm install -g localtunnel

      - name: Pull Docker image with Android
        run: docker pull budtmo/docker-android-x86-8.1

      - name: Run Android in Docker
        run: |
          docker run -d --name android-container \
            -p 6080:6080 \
            -e DEVICE="pixel" \
            -e EMULATOR_ARGS="-no-window -noaudio -gpu swiftshader_indirect" \
            budtmo/docker-android-x86-8.1
          sleep 60

      - name: Start LocalTunnel
        run: |
          lt --port 6080 --subdomain androidemul-$(date +%s) > lt.log 2>&1 &
          sleep 10
          cat lt.log
          echo "URL=$(grep -o 'https://[a-z0-9.-]*.loca.lt' lt.log | head -1)" >> $GITHUB_ENV

      - name: Show access URL
        run: echo "ğŸŒ Open Android in browser: $URL/vnc.html"

      - name: Keep alive for 2 hours
        run: sleep 7200
